{
    "contents" : "library(shiny)\nlibrary(dplyr)\nlibrary(lubridate)\nlibrary(ggvis)\n\ndata <- read.csv(file=\"offworldreplay.csv\",head=TRUE,sep=\",\")\nbuildingtypes <- read.csv(file=\"buildings.csv\",head=TRUE,sep=\",\")\nbuildcsum <-  read.csv(file=\"offworldreplaybuildsum.csv\", head=TRUE, sep=\",\")\nbuildsum_mod <- read.csv(file=\"buildsum_mod.csv\", head=TRUE, sep=\",\", stringsAsFactors = FALSE)\n\nbuildcsum$Time <- buildcsum$Time %>% format(format = \"%M:%S\") %>% as.POSIXct(format =\"%M:%S\")\nbuildsum_mod$Time <- buildsum_mod$Time %>% format(format = \"%M:%S\") %>% as.POSIXct(format =\"%M:%S\")\ndata$Time <- data$Time %>% format(format = \"%M:%S\") %>% as.POSIXct(format =\"%M:%S\")\n\nbuildingtypes$Image <- paste('<img src=\"', buildingtypes$Image, '\" height=30 title=\"', buildingtypes$Building, '\" />', sep ='')\n\nplotdata <- select(data, Time, Buildings, Player, Message)\nplotdata$Player <- factor(plotdata$Player, levels=c('Totakeke', 'Ms. Production', 'Mr. Sabotage', 'Ms. Launch'))\n\nstarttime <- head(plotdata$Time, 1)\n\ncolor <- c('#379FA8', '#B82327', '#76A73E', '#E16823')\nplayer <- unique(plotdata$Player)\nplayercolor <- data.frame(color, player)\nplotdata<-left_join(plotdata, playercolor, c(\"Player\"=\"player\"))\n\ncolnames1 <- as.matrix(buildingtypes$Image)[1:10]\ncolnames2 <- as.matrix(buildingtypes$Image)[11:20] \n\nshinyServer(function(input, output) {\n  \n  timelim <- reactive({starttime + input$timebar*60})\n  \n  builddata <- reactive({buildcsum[buildcsum$Time <= timelim(),]})\n  moddata <- reactive({buildsum_mod[buildsum_mod$Time <= timelim(),]})\n  \n  graphdata <- reactive({temp <- plotdata[plotdata$Time <= timelim(),]})\n  \n  graphdata %>% \n    ggvis(~Time, ~Buildings, stroke:=~color) %>% \n    layer_lines(strokeWidth:=2) %>%\n  add_axis(\"x\", \n           orient = \"bottom\", \n           tick_size_major=0, \n           format=\"%M\", \n           title =\"\",\n           properties = axis_props(\n             axis = list(stroke=\"#545351\",\n                         strokeWidth=2.5),\n             grid = list(stroke=\"#545351\",\n                         strokeWidth=0.5),\n             labels = list(\n               fill = \"#555553\",\n               fontSize = 10,\n               align = \"left\",\n               dx = -1\n             ),\n           )) %>%\n  add_axis(\"x\",\n           orient = \"top\",\n           tick_size_major=0, \n           title = \"\",\n           properties = axis_props(\n             axis = list(stroke=\"#545351\",\n                         strokeWidth=2.5),\n             grid = list(stroke=\"transparent\"),\n             labels = list(fill = \"transparent\"))) %>%\n  add_axis(\"y\",\n           orient = \"right\",\n           tick_size_major=0, \n           title = \"\",\n           properties = axis_props(\n             axis = list(stroke=\"#545351\",\n                         strokeWidth=2.5),\n             grid = list(stroke=\"transparent\"),\n             labels = list(fill = \"transparent\"))) %>%\n  add_axis(\"y\", \n           orient = \"left\", \n           tick_size_major=0, \n           title = \"\",\n           properties = axis_props(\n             axis = list(stroke=\"#545351\",\n                         strokeWidth=2.5),\n             grid = list(stroke=\"#545351\",\n                         strokeWidth=0.5),\n             labels = list(\n               fill = \"#555553\",\n               fontSize = 10\n             ),\n           )) %>%\n    hide_legend(\"fill\") %>%\n    hide_legend(\"stroke\") %>%\n    scale_datetime(\"x\", domain = c(min(plotdata$Time), max(plotdata$Time)), expand=c(0,0)) %>%\n    scale_numeric(\"y\", domain = c(0, max(plotdata$Buildings)+7), expand=c(0,0),  nice = FALSE) %>% \n    set_options(width = 700, height = 500) %>%\n    bind_shiny(\"ggvis\", \"ggvis_ui\")\n  \n  output$build1 <- renderTable({\n      player1 <- builddata() %>% filter(Player==\"Totakeke\") %>% select(-Player) %>% tail(1)\n      mod1 <- moddata() %>% filter(Player==\"Totakeke\") %>% select(-Player) %>% tail(1)\n      player1[2:21] <- paste0(mod1[,2:21],player1[,2:21],\"</div>\")\n      build1 <- rbind(colnames1,\n                      as.matrix(select(player1, 2:11)),\n                      colnames2,\n                  as.matrix(select(player1, 12:21)))\n  rownames(build1)<-NULL\n  build1\n    },\n  include.colnames=FALSE,\n  include.rownames=FALSE,\n  sanitize.text.function = function(x) x\n  ) \n\n  output$build2 <- renderTable({\n    player2 <- builddata() %>% filter(Player==\"Ms. Production\") %>% select(-Player) %>% tail(1)\n    mod2 <- moddata() %>% filter(Player==\"Ms. Production\") %>% select(-Player) %>% tail(1)\n    player2[2:21] <- paste0(mod2[,2:21],player2[,2:21],\"</div>\")\n    build2 <- rbind(colnames1,\n                    as.matrix(select(player2, 2:11)),\n                    colnames2,\n                    as.matrix(select(player2, 12:21)))\n    rownames(build2)<-NULL\n    build2\n  },\n  include.colnames=FALSE,\n  include.rownames=FALSE,\n  sanitize.text.function = function(x) x\n  ) \n  \n  output$build3 <- renderTable({\n    player3 <- builddata() %>% filter(Player==\"Mr. Sabotage\") %>% select(-Player) %>% tail(1)\n    mod3 <- moddata() %>% filter(Player==\"Mr. Sabotage\") %>% select(-Player) %>% tail(1)\n    player3[2:21] <- paste0(mod3[,2:21],player3[,2:21],\"</div>\")\n    build3 <- rbind(colnames1,\n                    as.matrix(select(player3, 2:11)),\n                    colnames2,\n                    as.matrix(select(player3, 12:21)))\n    rownames(build3)<-NULL\n    build3\n  },\n  include.colnames=FALSE,\n  include.rownames=FALSE,\n  sanitize.text.function = function(x) x\n  ) \n\n  output$build4 <- renderTable({\n    player4 <- builddata() %>% filter(Player==\"Ms. Launch\") %>% select(-Player) %>% tail(1)\n    mod4 <- moddata() %>% filter(Player==\"Ms. Launch\") %>% select(-Player) %>% tail(1)\n    player4[2:21] <- paste0(mod4[,2:21],player4[,2:21],\"</div>\")\n    build4 <- rbind(colnames1,\n                    as.matrix(select(player4, 2:11)),\n                    colnames2,\n                    as.matrix(select(player4, 12:21)))\n    rownames(build4)<-NULL\n    build4\n  },\n  include.colnames=FALSE,\n  include.rownames=FALSE,\n  sanitize.text.function = function(x) x\n  ) \n\n  output$test <- renderText(timelim())  \n\n  output$chat <- renderUI({\n    messages <- data[data$Time <= timelim(),]\n    messages <- messages[!messages$Message==\"\", ]\n    messages <- paste(\"[\", strftime(messages$Time, format=\"%M:%S\"), \"] \", messages$Message, sep='')\n    if (length(messages) > 1) {\n      HTML(as.vector(c(messages[1],paste0(\"</br>\", messages[2:length(messages)]))))\n    }\n    else {\n      HTML(as.vector(messages))\n    }    \n  })\n})\n\n",
    "created" : 1427163137316.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1549817576",
    "id" : "DEFDF40E",
    "lastKnownWriteTime" : 1427170319,
    "path" : "~/GitHub/edav/assets/justin/app/server.R",
    "project_path" : "server.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}